
<script type="module" lang="ts">
  import { html, render, directive } from 'https://unpkg.com/lit-html?module';
  

  var webSiteData = "";
  var serviceWorkerCode = "";
  const vscode = acquireVsCodeApi();

  window.onload = () => {
    vscode.postMessage({
      name: 'Ready!!!!!!'
    })
  }

  window.addEventListener('message', event => {
    var serviceWorkers = event.data.data;
    var serviceworker$ = serviceWorkers[0].id;
    const helloDirective = directive((id) => (part) => { serviceworker$ = id; });

    const rightSectionTopViewer = (webSiteData) => html`<pre class="language-javascript"><code class="language-javascript">${webSiteData}</code></pre>`;
    const rightSectionBottomViewer = (serviceWorkerCode) => html`<pre class="language-javascript"><code class="language-javascript">${serviceWorkerCode}</code></pre>`;
    const page = () => html`
      
    <head>
      <link rel="stylesheet" href="http://prismjs.com/themes/prism-tomorrow.css"/>

    
    </head>
    <body>
    </body>
      <style>
        .column {
        float: left;
        width: 40%;
        padding: 20px
        }
        .row1 {
          float: top;
          height: 50%;
        }
        .row2 {
          float: bottom;
          height: 50%;
        }

        .serviceWorkerType {
          display: flex;
          align-items: center;
        }

        .swTypeInnerDiv {
          margin-left: 2em;
        }
        
      </style>
      
      <form>
      
      <div class="column">
        <h2><b>Choose a service worker</b></h2></br>
      <h3> Service workers can make your site work offline, run faster, or both. Choose the functionality from our service workers below.</h3>
        ${serviceWorkers.map((i) => html`<div class="serviceWorkerType"><input type="radio"  name="swgroup" value="${i.id}" id="selectsw${i.id}"><div class="swTypeInnerDiv"><h4>${i.title}</h4><span> ${i.description}</span></div></div></br> `)}
      </ul>
      </br>
      <button id="download">Add Service Worker</button>
      <button id="preview"> Preview</button>
      </form>
    </div>
      <div class="column">
        <h3>Add this code to your landing page in a &lt;script&gt; tag:</h3></br>
        <div >
        ${rightSectionTopViewer(webSiteData)}
        </div>

        </br>
        <div >
        <h3>Add this code to a file named "pwabuilder-sw.js" on your site root:</h3></br>  
        <div>
        ${rightSectionBottomViewer(serviceWorkerCode)}
        </div>
        </div>
    

  
    </div>
    `;
    getCode(serviceworker$).then((data) => {
      render(page(), document.body);

      // var myScript = document.createElement('script');
      // myScript.setAttribute('src', 'http://prismjs.com/prism.js');
      // document.head.appendChild(myScript);
      const swradios = document.getElementsByName("swgroup");
      document.getElementById("selectsw1").checked = true;

      for (var i = 0; i < swradios.length; i++) {
        swradios[i].onchange = async function () {
          console.log(this.value);
          /*await getCode(this.value).then((data) => { 
            console.log('data from getCode', data);
            render(page(), document.body); 
          });*/
          await getCode(this.value);
          console.log(page());
          //render(html`<h1>hello world</h1>`, document.body);
          render(page(), document.body);
          serviceworker$ = this.value;

        }
      }

      document.getElementById("download").onclick = function (event) {
        console.log('download')
        // event.preventDefault();
        download(serviceworker$, this.id);
        // return false;
      }

      document.getElementById("preview").onclick = function () {
        console.log('inspecting');
        inspect(serviceworker$, this.id);
      }

    })
  });
  async function getCode(serviceWorkerId) {

    return await fetch(`https://pwabuilder-api-prod.azurewebsites.net/serviceworkers/previewcode?ids=${serviceWorkerId}`)
      .then
      ((res) => res.json()).then((data) => {
        console.log(data);
        webSiteData = data.webSite;
        serviceWorkerCode = data.serviceWorker;

      });



  }

  function inspect(serviceWorkerId, command) {

    vscode.postMessage({
      name: 'sw',
      serviceWorkerId: serviceWorkerId,
      type: command
    })


  }

  function download(serviceWorkerId, command) {

    vscode.postMessage({
      name: 'download',
      serviceWorkerId: serviceWorkerId,
      type: command

    })


  }





</script>
